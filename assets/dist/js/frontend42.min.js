angular.module("frontend42",[]),angular.module("admin42").directive("formBlock",[function(){return{restrict:"E",templateUrl:function(elem,attrs){return attrs.template},scope:{elementDataId:"@elementDataId"},controller:["$scope","jsonCache","$templateCache","$formService",function($scope,jsonCache,$templateCache,$formService){var elementData=jsonCache.get($scope.elementDataId);$scope.label=elementData.label,$scope.protoTypes=elementData.protoTypes,$scope.data={selectedProtoType:$scope.protoTypes[0]},$scope.treeOptions={},$scope.sortingMode=!1,$scope.elements=[],angular.forEach(elementData.elements,function(element){var id=elementData.id+"-"+$scope.elements.length,templateName="element/form/stack/"+id+".html",elementOrFieldsetData=angular.copy(jsonCache.get(element.elementDataId)),elementOrFieldsetDataKey="element/form/value/"+id+".json";elementOrFieldsetData.id=id,elementOrFieldsetData.name=elementData.name+"["+elementOrFieldsetData.options.originalName+"]",jsonCache.put(elementOrFieldsetDataKey,elementOrFieldsetData),$templateCache.put(templateName,"<"+element.directive+' element-data-id="'+elementOrFieldsetDataKey+'" template="'+elementOrFieldsetData.template+'"></'+element.directive+">"),$scope.elements.push({formName:elementOrFieldsetData.name,type:elementOrFieldsetData.options.stackType,name:elementOrFieldsetData.options.fieldsetName,nameEditing:!1,template:templateName,elementDataId:elementOrFieldsetDataKey,label:elementOrFieldsetData.label,deleted:elementOrFieldsetData.options.fieldsetDeleted,collapsed:$scope.sortingMode,collapsedState:!1,nodes:[]})}),$scope.collapse=function(){angular.forEach($scope.elements,function(element){element.collapsed!==!0&&(element.collapsedState=element.collapsed,element.collapsed=!0)})},$scope.expand=function(){angular.forEach($scope.elements,function(element){element.collapsed=element.collapsedState})},$scope.preventEnter=function(element,$event){13==$event.keyCode&&(element.nameEditing=!1,$event.preventDefault())},$scope.startSortingMode=function(){return $scope.sortingMode===!1?($scope.$broadcast("$dynamic:sort-start"),$scope.sortingMode=!0,void $scope.collapse()):($scope.expand(),$scope.$broadcast("$dynamic:sort-stop"),void($scope.sortingMode=!1))},$scope.addTemplate=function(){var id=elementData.id+"-"+$scope.elements.length,element=$scope.data.selectedProtoType,templateName="element/form/stack/"+id+".html",elementOrFieldsetData=angular.copy(jsonCache.get(element.elementData)),elementOrFieldsetDataKey="element/form/value/"+id+".json";elementOrFieldsetData.id=id,elementOrFieldsetData.options.originalName=id,elementOrFieldsetData.name=elementData.name+"["+elementOrFieldsetData.options.originalName+"]",jsonCache.put(elementOrFieldsetDataKey,elementOrFieldsetData),$templateCache.put(templateName,"<"+element.directive+' element-data-id="'+elementOrFieldsetDataKey+'" template="'+elementOrFieldsetData.template+'"></'+element.directive+">"),$scope.elements.push({formName:elementOrFieldsetData.name,type:elementOrFieldsetData.options.stackType,name:"",nameEditing:!1,template:templateName,elementDataId:elementOrFieldsetDataKey,label:elementOrFieldsetData.label,deleted:!1,collapsed:$scope.sortingMode,collapsedState:!1,nodes:[]})},angular.isDefined(elementData.options.formServiceHash)&&$formService.put(elementData.options.formServiceHash,elementData.name,$scope.elementDataId)}]}}]),angular.module("frontend42").controller("SitemapController",["$scope","$http","$attrs",function($scope,$http,$attrs){$scope.isLoading=!0,$scope.locale=$attrs.locale,$scope.sitemap=[],$scope.query="",$scope.treeOptions={accept:function(sourceNodeScope,destNodesScope){var parent=destNodesScope.$parent;return angular.isUndefined(parent.$modelValue)?!1:angular.isUndefined(sourceNodeScope.$modelValue)?!1:parent.$modelValue.isTerminal===!0?!1:0===parent.$modelValue.pageTypes.length?!1:parent.$modelValue.pageTypes.hasOwnProperty(sourceNodeScope.$modelValue.pageType)?!0:!1},dropped:function(){$scope.isLoading=!0,$http.post($attrs.sortSaveUrl,$scope.sitemap).success(function(){loadTree()}).error(function(){$scope.isLoading=!1})}};var loadTree=function(){$scope.isLoading=!0;var options={locale:$scope.locale};$http.post($attrs.sitemapUrl,options).success(function(data){$scope.sitemap=data,$scope.isLoading=!1}).error(function(){$scope.sitemap=[],$scope.isLoading=!1})};loadTree(),$scope.visible=function(item){if(!$scope.query||0==$scope.query.length)return!0;if(item.title.toLowerCase().indexOf($scope.query.toLowerCase())>-1)return!0;if(item.items.length>0)for(var i=0,len=item.items.length;len>i;i++)if(1==$scope.visible(item.items[i]))return!0;return!1},$scope.canAddPage=function(item){return item.isTerminal===!0?!1:0!==item.pageTypes.length},$scope.deleteCallback=function(){loadTree()}}]);